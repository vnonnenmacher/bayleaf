version: "3.9"

networks:
  bayleaf_net:
    name: bayleaf_net

x-api-base: &api-base
  build: .
  working_dir: /usr/src/app
  environment:
    # These are defaults; override via --env-file if you like
    DJANGO_SETTINGS_MODULE: "bayleaf.settings.prod"
    DJANGO_SECRET_KEY: ${DJANGO_SECRET_KEY}
    BAYLEAF_RSA_PRIVATE_KEY: ${BAYLEAF_RSA_PRIVATE_KEY}
    BAYLEAF_RSA_PUBLIC_KEY: ${BAYLEAF_RSA_PUBLIC_KEY}
    ALLOWED_HOSTS: ${ALLOWED_HOSTS}
    CORS_ALLOW_ALL_ORIGINS: ${CORS_ALLOW_ALL_ORIGINS:-"0"}
    CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}
    CSRF_TRUSTED_ORIGINS: ${CSRF_TRUSTED_ORIGINS}
    RUN_MODE: "prod"
    DB_HOST: "db"
    DB_NAME: "bayleaf"
    DB_USER: "bayleaf"
    DB_PASSWORD: "bayleaf"
    MINIO_ENDPOINT: ${MINIO_ENDPOINT:-"minio:9000"}
    MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
    MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
    MINIO_USE_SSL: ${MINIO_USE_SSL:-"false"}
    MINIO_PUBLIC_ENDPOINT: ${MINIO_PUBLIC_ENDPOINT:-"localhost:9000"}
    MINIO_PUBLIC_USE_SSL: ${MINIO_PUBLIC_USE_SSL:-"false"}
    MINIO_REGION: ${MINIO_REGION:-""}
    BAYLEAF_DOCS_BUCKET: ${BAYLEAF_DOCS_BUCKET:-"bayleaf-documents"}
    MINIO_PRESIGN_EXPIRES: ${MINIO_PRESIGN_EXPIRES:-"900"}
  networks: [bayleaf_net]
  depends_on:
    db:
      condition: service_healthy
    minio:
      condition: service_started
    minio_init:
      condition: service_completed_successfully

services:
  # --- Production app (uWSGI) ---
  api:
    <<: *api-base
    profiles: ["prod"]
    ports:
      - "8000:8000"
    # No bind mounts in prod; code is baked into the image

  # --- Development app (runserver + hot reload) ---
  api-dev:
    <<: *api-base
    profiles: ["dev"]
    environment:
      DJANGO_SETTINGS_MODULE: "bayleaf.settings.dev"
      RUN_MODE: "dev"
      DEBUG: "1"
      DB_HOST: "db"
      DB_NAME: "bayleaf"
      DB_USER: "bayleaf"
      DB_PASSWORD: "bayleaf"
    ports:
      - "8000:8000"
    volumes:
      - .:/usr/src/app

  db:
    image: postgres:16
    networks: [bayleaf_net]
    environment:
      POSTGRES_USER: bayleaf
      POSTGRES_PASSWORD: bayleaf
      POSTGRES_DB: bayleaf
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bayleaf -d bayleaf"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

  minio:
    image: minio/minio
    networks: [bayleaf_net]
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data
    restart: unless-stopped

  minio_init:
    image: minio/mc
    networks: [bayleaf_net]
    depends_on:
      minio:
        condition: service_started
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-minioadmin} &&
      mc mb -p local/${BAYLEAF_DOCS_BUCKET:-bayleaf-documents} || true
      "
    restart: "no"

volumes:
  postgres_data:
  minio_data:
