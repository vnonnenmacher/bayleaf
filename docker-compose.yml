version: "3.9"

x-api-base: &api-base
  build: .
  working_dir: /usr/src/app
  environment:
    # These are defaults; override via --env-file if you like
    DJANGO_SETTINGS_MODULE: "bayleaf.settings.prod"
    RUN_MODE: "prod"
    DB_HOST: "db"
    DB_NAME: "bayleaf"
    DB_USER: "bayleaf"
    DB_PASSWORD: "bayleaf"
  depends_on:
    db:
      condition: service_healthy

services:
  # --- Production app (uWSGI) ---
  api:
    <<: *api-base
    profiles: ["prod"]
    ports:
      - "8000:8000"
    # No bind mounts in prod; code is baked into the image

  # --- Development app (runserver + hot reload) ---
  api-dev:
    <<: *api-base
    profiles: ["dev"]
    environment:
      DJANGO_SETTINGS_MODULE: "bayleaf.settings.dev"
      RUN_MODE: "dev"
      DEBUG: "1"
      DB_HOST: "db"
      DB_NAME: "bayleaf"
      DB_USER: "bayleaf"
      DB_PASSWORD: "bayleaf"
    ports:
      - "8000:8000"
    volumes:
      - .:/usr/src/app

  db:
    image: postgres:16
    environment:
      POSTGRES_USER: bayleaf
      POSTGRES_PASSWORD: bayleaf
      POSTGRES_DB: bayleaf
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U bayleaf -d bayleaf"]
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

volumes:
  postgres_data:
